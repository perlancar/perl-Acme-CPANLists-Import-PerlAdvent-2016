<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.113" />
    <link rel="alternate" title="Perl Advent Calendar 2016 XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link rel="stylesheet" href="2016.css" type="text/css" />
    <title>
Perl Advent Calendar 2016 - 
Using PPI for static analysis

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">Perl Advent Calendar 2016</a></h1>
        </div>

        <p id="tagline">2016 twenty four merry days of Perl
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Using PPI for static analysis</h1>
<div class='subtitle'>PPI - 2016-12-14</div>

<div class='pod'><p>This article is based on a talk I presented this year in Orlando at The Perl Conference 2016 (formerly known as YAPC::NA 2016).</p>

<p>The talk itself was oriented on how and why to find dead code in a program. It&#39;s very common that a program loads many many modules where actually in its life cycle only a few of them are either used or partially used.</p>

<p>All of this &#39;unused&#39; code could impact memory and performance of your program. If your program runs for a long time as a daemon then it can use up more memory than it should, and if your program runs for a short period of time loading all this extra code can slow it down significantly.</p>

<p>Finding &#39;dead code&#39; by static analysis is vowed to failure and comes with its own caveats due to the dynamic nature of perl... which can create/call functions at run time... so you cannot know for sure that a specific function will never be called.</p>

<p>Rather than being a duplicate of the talk which you can find online (view links at the end of the article). I&#39;m going to show some PPI usages after introducing the basics of INC.</p>

<h3 id="INC-Basics">INC Basics</h3>

<p>Perl uses two versions of INC: @INC as an array and %INC as a hash. As for any other variables sharing the same name but using a different &#39;type&#39; these two are different.</p>

<ul>

<li><p><code>@INC</code>: is an array which contains path where to look for new modules</p>

</li>
<li><p><code>%INC</code>: is a hash which saved the location of each already loaded module</p>

</li>
</ul>

<h4 id="Sample-usage-of-INC-and-INC">Sample usage of @INC and %INC</h4>

<p>Note that you can check at anytime the default value of <code>@INC</code>, by running <code>perl -V</code> command. This is depending on your environment variables as the custom <code>PERL5LIB</code> path are taken into account.</p>

<pre><code>    &gt; echo $PERL5LIB
    /Users/nicolas/.dotfiles/perl-must-have/lib:/Users/nicolas/perl5/lib/perl5/

    &gt; perl -V
    ...
      @INC:
    /Users/nicolas/.dotfiles/perl-must-have/lib
    /Users/nicolas/perl5/lib/perl5/
    /Users/nicolas/perl5/perlbrew/perls/perl-5.22.1/lib/site_perl/5.22.1/darwin-2level
    /Users/nicolas/perl5/perlbrew/perls/perl-5.22.1/lib/site_perl/5.22.1
    /Users/nicolas/perl5/perlbrew/perls/perl-5.22.1/lib/5.22.1/darwin-2level
    /Users/nicolas/perl5/perlbrew/perls/perl-5.22.1/lib/5.22.1
    .</code></pre>

<p>You can also display the content of <code>@INC</code> and <code>%INC</code> directly from your program</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!perl<br /></span><span class="keyword">use</span> <span class="version">v5.022</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="pragma">warnings</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">strict</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Simple::Accessor</span><span class="structure">;</span><br /><br /><span class="word">say</span> <span class="literal">q{# @INC:}</span><span class="structure">;</span><br /><span class="word">say</span> <span class="word">foreach</span> <span class="symbol">@INC</span><span class="structure">;</span><br /><br /><span class="word">say</span> <span class="interpolate">qq{\n}</span><span class="operator">,</span> <span class="literal">q{# %INC:}</span><span class="structure">;</span><br /><span class="keyword">foreach</span> <span class="structure">(</span> <span class="word">sort</span> <span class="word">keys</span> <span class="symbol">%INC</span> <span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">say</span> <span class="magic">$_</span><span class="operator">,</span> <span class="single">' =&gt; '</span><span class="operator">,</span> <span class="symbol">$INC</span><span class="structure">{</span><span class="magic">$_</span><span class="structure">};</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>When run on my local system the output looks like this, it should be similar on yours.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment"># @INC:<br /></span><span class="match">/Users/nicolas</span><span class="operator">/</span><span class="word">perl5</span><span class="operator">/</span><span class="word">perlbrew</span><span class="operator">/</span><span class="word">perls</span><span class="operator">/</span><span class="word">perl</span><span class="version">-5.22.1</span><span class="operator">/</span><span class="word">lib</span><span class="operator">/</span><span class="word">site_perl</span><span class="operator">/</span><span class="version">5.22.1</span><span class="operator">/</span><span class="word">darwin</span><span class="number">-2</span><span class="word">level</span><br /><span class="operator">/</span><span class="word">Users</span><span class="operator">/</span><span class="word">nicolas</span><span class="operator">/</span><span class="word">perl5</span><span class="operator">/</span><span class="word">perlbrew</span><span class="operator">/</span><span class="word">perls</span><span class="operator">/</span><span class="word">perl</span><span class="version">-5.22.1</span><span class="operator">/</span><span class="word">lib</span><span class="operator">/</span><span class="word">site_perl</span><span class="operator">/</span><span class="version">5.22.1</span><br /><span class="operator">/</span><span class="word">Users</span><span class="operator">/</span><span class="word">nicolas</span><span class="operator">/</span><span class="word">perl5</span><span class="operator">/</span><span class="word">perlbrew</span><span class="operator">/</span><span class="word">perls</span><span class="operator">/</span><span class="word">perl</span><span class="version">-5.22.1</span><span class="operator">/</span><span class="word">lib</span><span class="operator">/</span><span class="version">5.22.1</span><span class="operator">/</span><span class="word">darwin</span><span class="number">-2</span><span class="word">level</span><br /><span class="operator">/</span><span class="word">Users</span><span class="operator">/</span><span class="word">nicolas</span><span class="operator">/</span><span class="word">perl5</span><span class="operator">/</span><span class="word">perlbrew</span><span class="operator">/</span><span class="word">perls</span><span class="operator">/</span><span class="word">perl</span><span class="version">-5.22.1</span><span class="operator">/</span><span class="word">lib</span><span class="operator">/</span><span class="version">5.22.1</span><br /><span class="operator">.</span><br /><br /><span class="comment"># %INC:<br /></span><span class="word">Simple</span><span class="operator">/</span><span class="word">Accessor</span><span class="operator">.</span><span class="word">pm</span> <span class="operator">=&gt;</span> <span class="match">/Users/nicolas</span><span class="operator">/</span><span class="word">perl5</span><span class="operator">/</span><span class="word">perlbrew</span><span class="operator">/</span><span class="word">perls</span><span class="operator">/</span><span class="word">perl</span><span class="version">-5.22.1</span><span class="operator">/</span><span class="word">lib</span><span class="operator">/</span><span class="word">site_perl</span><span class="operator">/</span><span class="version">5.22.1</span><span class="operator">/</span><span class="word">Simple</span><span class="operator">/</span><span class="word">Accessor</span><span class="operator">.</span><span class="word">pm</span><br /><span class="word">strict</span><span class="operator">.</span><span class="word">pm</span> <span class="operator">=&gt;</span> <span class="match">/Users/nicolas</span><span class="operator">/</span><span class="word">perl5</span><span class="operator">/</span><span class="word">perlbrew</span><span class="operator">/</span><span class="word">perls</span><span class="operator">/</span><span class="word">perl</span><span class="version">-5.22.1</span><span class="operator">/</span><span class="word">lib</span><span class="operator">/</span><span class="version">5.22.1</span><span class="operator">/</span><span class="word">strict</span><span class="operator">.</span><span class="word">pm</span><br /><span class="word">warnings</span><span class="operator">.</span><span class="word">pm</span> <span class="operator">=&gt;</span> <span class="match">/Users/nicolas</span><span class="operator">/</span><span class="word">perl5</span><span class="operator">/</span><span class="word">perlbrew</span><span class="operator">/</span><span class="word">perls</span><span class="operator">/</span><span class="word">perl</span><span class="version">-5.22.1</span><span class="operator">/</span><span class="word">lib</span><span class="operator">/</span><span class="version">5.22.1</span><span class="operator">/</span><span class="word">warnings</span><span class="operator">.</span><span class="word">pm</span></code><br />&nbsp;</td></table>

<p>Note that the keys of %INC are not using the module name as <code>Foo::Bar</code> but the short path version as <code>Foo/Bar.pm</code> (even on operating systems like Windows that do not use this path specification normally). Remember that a single file can provide multiple packages.</p>

<h4 id="Messing-around-with-INC-and-INC">Messing around with <code>@INC</code> and <code>%INC</code></h4>

<p>Both <code>@INC</code> and <code>%INC</code> are read/write... which means you can cheat and lie to perl at run time by customizing them.</p>

<dl>

<dt>Customizing @INC</dt>
<dd>

<p>By tweaking <code>@INC</code> you can change the behavior of a program by forcing it to load modules from a different path... or even do not look in a generic path at all.</p>

<p>The most common use case is to add one known path to it as in this sample code where a custom path is added in first position of <code>@INC</code>.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!perl<br /></span><br /><span class="keyword">BEGIN</span> <span class="structure">{</span> <span class="word">unshift</span> <span class="symbol">@INC</span><span class="operator">,</span> <span class="double">&quot;/search/in/this/path/first&quot;</span> <span class="structure">}</span><br /><br /><span class="keyword">use</span> <span class="word">My::Module</span> <span class="structure">();</span></code><br />&nbsp;</td></table>

<p>We need to wrap the modification to <code>@INC</code> in a <code>BEGIN { ... }</code> block to ensure it happens at <i>compile time</i>. This is the time where perl first scans over the source code and loads all the modules - and if we&#39;re changing the contents of <code>@INC</code> we need to use <code>BEGIN</code> to ensure it happens during compile time before perl processes any <code>use</code> statements that might be effected by it.</p>

<p>Adding things to <code>@INC</code> is common enough in Perl that there&#39;s the familiar syntactic sugar for it:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="pragma">lib</span> <span class="words">qw(/search/in/this/path/first)</span><span class="structure">;</span></code><br />&nbsp;</td></table>

</dd>
<dt>Customizing %INC</dt>
<dd>

<p>Updating %INC is less common but also provides some great value - only use it with care - but this is an easy way to avoid loading a useless (not used during the life of your program) module.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!perl<br /></span><br /><span class="keyword">BEGIN</span> <span class="structure">{</span> <span class="symbol">$INC</span><span class="structure">{</span><span class="double">&quot;Useless/Module.pm&quot;</span><span class="structure">}</span> <span class="operator">=</span> <span class="single">'__FAKE__'</span><span class="structure">;</span> <span class="structure">}</span><br /><br /><span class="comment"># this use or require will not try to load the module<br /></span><br /><span class="keyword">use</span> <span class="word">Useless::Module</span><span class="structure">;</span><br /><span class="word">require</span> <span class="word">Useless::Module</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>Because perl now has a value in <code>%INC</code> for <code>Useless::Module</code> it won&#39;t try and actually load it whenever it finds a <code>use Useless::Module</code>, either directly in the script itself or indirectly any of the modules loaded by the script.</p>

</dd>
</dl>

<h3 id="Listing-dependencies-of-a-script">Listing dependencies of a script</h3>

<p>We now know that modules loaded by a script are advertised in %INC. If we could read %INC just before the program starts, this could gives a picture of all required modules at this time. (note that some module might be lazy loaded later...)</p>

<p>This is exactly what we can achieve using a CHECK block.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Devel::ListDeps</span><span class="structure">;</span><br /><br /><span class="keyword">CHECK</span> <span class="structure">{</span><br />&nbsp;&nbsp;<span class="keyword">foreach</span> <span class="keyword">my</span> <span class="symbol">$module</span> <span class="structure">(</span> <span class="word">sort</span> <span class="word">keys</span> <span class="symbol">%INC</span> <span class="structure">)</span> <span class="structure">{</span><br /><span class="comment">    # exclude ourself: could also use __PACKAGE__<br /></span>    <span class="word">next</span> <span class="word">if</span> <span class="symbol">$module</span> <span class="operator">eq</span> <span class="single">'Devel/ListDeps.pm'</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">print</span> <span class="interpolate">qq{$module\n}</span><span class="structure">;</span><br />&nbsp;&nbsp;<span class="structure">}</span><br /><span class="structure">}</span><br /><br /><span class="number">1</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>Let&#39;s now use it on a very simple program which is just using strict and warnings.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!perl<br /></span><br /><span class="keyword">use</span> <span class="pragma">strict</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">warnings</span><span class="structure">;</span><br /><br /><span class="word">print</span> <span class="interpolate">qq{hello World\n}</span><span class="structure">;</span> <span class="comment"># or say</span></code><br />&nbsp;</td></table>

<p>We are here using <code>-d</code> to load our Devel package (if the module is not in your <code>@INC</code> you might need to use <code>-I</code> to modify <code>@INC</code> from the command line so Perl knows where to load it from) )</p>

<pre><code>  &gt; perl -c -d:ListDeps samples/hello-world.pl
  strict.pm
  warnings.pm
  samples/hello-world.pl syntax OK</code></pre>

<p>As we can see we can get the list of dependencies from a script without altering it. Also note that the program was not executed as we just asked perl to run with <code>-c</code> to stop executing after the CHECK block. <code>Hello World</code> is not printed.</p>

<p>We can also check that this is listing recursive dependencies by using something little more complex.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!perl<br /></span><br /><span class="keyword">use</span> <span class="pragma">strict</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">warnings</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Test::More</span><span class="structure">;</span><br /><br /><span class="word">print</span> <span class="interpolate">qq{hello World\n}</span><span class="structure">;</span> <span class="comment"># or say</span></code><br />&nbsp;</td></table>

<p>We can see that Test::More is listed as part of dependencies but other modules coming from Test::More are also now loaded.</p>

<pre><code>    &gt; perl -Ilib -c -d:ListDeps samples/hello-world.pl
    Config.pm
    Exporter.pm
    Exporter/Heavy.pm
    PerlIO.pm
    Test/Builder.pm
    Test/Builder/Module.pm
    Test/More.pm
    strict.pm
    vars.pm
    warnings.pm
    warnings/register.pm
    samples/hello-world.pl syntax OK</code></pre>

<p>As shown in the talk we could then wrap this in a script that could remove the last line and convert the short path to a package namespace to be more human friendly.</p>

<p>Then we could use it this way:</p>

<pre><code>    &gt; ./perl-dependencies samples/hello-world.pl
    Config
    Exporter
    Exporter::Heavy
    PerlIO
    Test::Builder
    Test::Builder::Module
    Test::More
    strict
    vars
    warnings
    warnings::register</code></pre>

<h3 id="Memory-profiling">Memory profiling</h3>

<p>Now that we are able to list all dependencies from a script. It would be nice to know the memory required by each module.</p>

<p>For this purpose I&#39;m going to use a one liner, which mainly works on Linux system. This needs some adjustment on macOS or other operating systems.</p>

<pre><code>    &gt; perl -e &#39;print qx{grep VmRSS /proc/$$/status}&#39;
    VmRSS:      1836 kB</code></pre>

<p>On Linux systems this metric is globally stable</p>

<pre><code>    &gt; for i in $(seq 1 4); do perl -e &#39;print qx{grep VmRSS /proc/$$/status}&#39;; done
    VmRSS:      1836 kB
    VmRSS:      1836 kB
    VmRSS:      1832 kB
    VmRSS:      1836 kB</code></pre>

<h4 id="Tracking-memory-usage-for-modules">Tracking memory usage for modules</h4>

<p>We can now track memory usage for each individual module</p>

<pre><code>    &gt; perl -MCarp -e &#39;print qx{grep VmRSS /proc/$$/status}&#39;
    VmRSS:      2872 kB

    &gt; perl -MData::Dumper -e &#39;print qx{grep VmRSS /proc/$$/status}&#39;
    VmRSS:      3728 kB

    &gt; perl -MMoose -e &#39;print qx{grep VmRSS /proc/$$/status}&#39;
    VmRSS:     16596 kB</code></pre>

<p>We can also check the memory used by more than a single module using the same oneliner.</p>

<pre><code>    &gt; perl -MCarp -MData::Dumper -e &#39;print qx{grep VmRSS /proc/$$/status}&#39;
    VmRSS:      3752 kB</code></pre>

<p>When loading Carp as well as Data::Dumper the total memory footprint stays same as when using Data::Dumper by itself. Why? The reason is that Data::Dumper itself is also using Carp</p>

<pre><code>    &gt; perl -MData::Dumper -E &#39;say $INC{&quot;Carp.pm&quot;}&#39;
    /usr/local/cpanel/3rdparty/perl/524/lib64/perl5/5.24.1/Carp.pm</code></pre>

<p>Similarly adding Moose to Data::Dumper, we can notice that the memory used is higher than Moose by itself but still below the sum</p>

<pre><code>    &gt; perl -MData::Dumper -MMoose -e &#39;print qx{grep VmRSS /proc/$$/status}&#39;
    VmRSS:     17132 kB</code></pre>

<p>We cannot do the simple math addition to know the memory used by multiple modules.</p>

<pre><code>    Memory(Moose) &lt; Memory( Moose &amp; Data::Dumper ) &lt; Memory(Moose) + Memory(Data::Dumper)</code></pre>

<p>Perl itself as its own startup memory cost, and modules could also used shared dependencies so we cannot count them more than once... as once a module is loaded, it&#39;s in and can be used at no additional cost by any other module.</p>

<h4 id="Tracking-memory-increase">Tracking memory increase</h4>

<p>This leads to an idea .. what about running the same oneliner each time a module is loaded? Is it possible? Yes we can use a custom debugger function which would be able to track all calls.</p>

<p>We could use either a change of state of <code>%INC</code> or also caller to know which file was just loaded. This script is pretty long and still need some tweaks but this is the main idea:</p>

<p>This is the current version</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;<br />42:&nbsp;<br />43:&nbsp;<br />44:&nbsp;<br />45:&nbsp;<br />46:&nbsp;<br />47:&nbsp;<br />48:&nbsp;<br />49:&nbsp;<br />50:&nbsp;<br />51:&nbsp;<br />52:&nbsp;<br />53:&nbsp;<br />54:&nbsp;<br />55:&nbsp;<br />56:&nbsp;<br />57:&nbsp;<br />58:&nbsp;<br />59:&nbsp;<br />60:&nbsp;<br />61:&nbsp;<br />62:&nbsp;<br />63:&nbsp;<br />64:&nbsp;<br />65:&nbsp;<br />66:&nbsp;<br />67:&nbsp;<br />68:&nbsp;<br />69:&nbsp;<br />70:&nbsp;<br />71:&nbsp;<br />72:&nbsp;<br />73:&nbsp;<br />74:&nbsp;<br />75:&nbsp;<br />76:&nbsp;<br />77:&nbsp;<br />78:&nbsp;<br />79:&nbsp;<br />80:&nbsp;<br />81:&nbsp;<br />82:&nbsp;<br />83:&nbsp;<br />84:&nbsp;<br />85:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Devel::ListDepsDetails</span><span class="structure">;</span><br /><br /><span class="keyword">BEGIN</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">sub</span> <span class="word">get_memory</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$m</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> <span class="structure">(</span> <span class="operator">-e</span> <span class="literal">q{/proc}</span> <span class="structure">)</span> <span class="structure">{</span> <span class="comment"># unix</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$m</span> <span class="operator">=</span> <span class="command">qx{grep VmRSS /proc/$$/status}</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span> <span class="keyword">else</span> <span class="structure">{</span> <span class="comment"># macOS (not consistent)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$m</span> <span class="operator">=</span> <span class="command">qx{ps -o rss -p $$ | tail -1}</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">int</span> <span class="symbol">$m</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">@inc</span> <span class="operator">=</span> <span class="word">sort</span> <span class="structure">{</span> <span class="word">length</span> <span class="symbol">$b</span> <span class="operator">&lt;=&gt;</span> <span class="word">length</span> <span class="symbol">$a</span> <span class="operator">or</span> <span class="symbol">$a</span> <span class="operator">cmp</span> <span class="symbol">$b</span> <span class="structure">}</span> <span class="symbol">@INC</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">sub</span> <span class="word">short</span>  <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$s</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">foreach</span> <span class="keyword">my</span> <span class="symbol">$in</span> <span class="structure">(</span> <span class="symbol">@inc</span> <span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">next</span> <span class="word">unless</span> <span class="symbol">$s</span> <span class="operator">=~</span> <span class="substitute">s{^$in/?}{}</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> <span class="structure">(</span> <span class="symbol">$s</span> <span class="operator">=~</span> <span class="regexp">qr{\.pm$}</span> <span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$s</span> <span class="operator">=~</span> <span class="substitute">s{\.pm$}{}</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$s</span> <span class="operator">=~</span> <span class="substitute">s{/+}{::}g</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">last</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$s</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">%seen</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$total_mem</span> <span class="operator">=</span> <span class="number">0</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">sub</span> <span class="word">DB::DB</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span> <span class="symbol">$package</span><span class="operator">,</span> <span class="symbol">$file</span><span class="operator">,</span> <span class="symbol">$line</span> <span class="structure">)</span> <span class="operator">=</span> <span class="word">caller</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">if</span> <span class="symbol">$file</span> <span class="operator">eq</span> <span class="single">'-e'</span> <span class="operator">||</span> <span class="symbol">$file</span> <span class="operator">eq</span> <span class="single">'-E'</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">if</span> <span class="symbol">$file</span> <span class="operator">=~</span> <span class="regexp">qr{^\(eval}</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">if</span> <span class="symbol">$seen</span><span class="structure">{</span><span class="symbol">$file</span><span class="structure">}</span><span class="operator">++</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$file</span> <span class="operator">||=</span> <span class="single">''</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$mem</span>   <span class="operator">=</span> <span class="word">get_memory</span><span class="structure">();</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$delta</span> <span class="operator">=</span> <span class="symbol">$mem</span> <span class="operator">-</span> <span class="symbol">$total_mem</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$total_mem</span> <span class="operator">=</span> <span class="symbol">$mem</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> <span class="structure">(</span> <span class="word">keys</span> <span class="symbol">%seen</span> <span class="operator">==</span> <span class="number">1</span> <span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">print</span> <span class="double">&quot;# [delta =&gt; total RSS in kB] module name (or eval)\n&quot;</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><br /><span class="comment">        # try to guess where it comes from (manual longmess :-)<br /></span>        <span class="keyword">my</span> <span class="structure">(</span> <span class="symbol">$frompkg</span><span class="operator">,</span> <span class="symbol">$fromfile</span><span class="operator">,</span> <span class="symbol">$fromline</span> <span class="structure">)</span> <span class="operator">=</span> <span class="word">caller</span><span class="structure">();</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$max</span> <span class="operator">=</span> <span class="number">1_000</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">foreach</span> <span class="keyword">my</span> <span class="symbol">$level</span> <span class="structure">(</span> <span class="number">0</span> <span class="operator">..</span> <span class="symbol">$max</span> <span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span> <span class="symbol">$package</span><span class="operator">,</span> <span class="symbol">$filename</span><span class="operator">,</span> <span class="symbol">$line</span> <span class="structure">)</span> <span class="operator">=</span> <span class="word">caller</span><span class="structure">(</span><span class="symbol">$level</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">last</span> <span class="word">unless</span> <span class="core">defined</span> <span class="symbol">$filename</span><span class="structure">;</span><br /><br /><span class="comment">            # when the filename differs, we know where it comes from<br /></span>            <span class="keyword">if</span> <span class="structure">(</span> <span class="symbol">$fromfile</span> <span class="operator">ne</span> <span class="symbol">$filename</span> <span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">(</span> <span class="symbol">$frompkg</span><span class="operator">,</span> <span class="symbol">$fromfile</span><span class="operator">,</span> <span class="symbol">$fromline</span> <span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">=</span> <span class="structure">(</span> <span class="symbol">$package</span><span class="operator">,</span> <span class="symbol">$filename</span><span class="operator">,</span> <span class="symbol">$line</span> <span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">last</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> <span class="structure">(</span> <span class="symbol">$level</span> <span class="operator">==</span> <span class="symbol">$max</span> <span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">(</span> <span class="symbol">$frompkg</span><span class="operator">,</span> <span class="symbol">$fromfile</span><span class="operator">,</span> <span class="symbol">$fromline</span> <span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">=</span> <span class="structure">(</span> <span class="single">'????'</span><span class="operator">,</span> <span class="single">'????'</span><span class="operator">,</span> <span class="single">'?'</span> <span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">print</span> <span class="word">sprintf</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="double">&quot;[%5s =&gt; %8d] %-50s from %-30s at line %d\n&quot;</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">(</span> <span class="symbol">$delta</span> <span class="operator">&gt;</span> <span class="number">0</span> <span class="operator">?</span> <span class="single">'+'</span> <span class="operator">:</span> <span class="single">''</span> <span class="structure">)</span> <span class="operator">.</span> <span class="symbol">$delta</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$mem</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">(</span> <span class="word">short</span><span class="structure">(</span><span class="symbol">$file</span><span class="structure">)</span> <span class="operator">||</span> <span class="single">'undef'</span> <span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">short</span><span class="structure">(</span><span class="symbol">$fromfile</span><span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$fromline</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">);</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><br /><span class="structure">}</span><br /><br /><span class="keyword">CHECK</span> <span class="structure">{</span> <span class="word">exit</span> <span class="structure">}</span><br /><br /><span class="number">1</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>We can then use it this way for example, either loading a script or directly on a module and each time we see a new file we check the memory and check how much it was increased.</p>

<pre><code>    &gt; perl -Ilib -d:ListDepsDetails -e &#39;require &quot;./samples/use-modules.pl&quot;&#39;
    # [delta =&gt; total RSS in kB] module name (or eval)
    [+2052 =&gt;     2052] samples/use-modules.pl                             from e                              at line 1
    [ +172 =&gt;     2224] strict                                             from samples/use-modules.pl         at line 3
    [ +356 =&gt;     2580] warnings                                           from samples/use-modules.pl         at line 4
    [  +40 =&gt;     2620] Carp                                               from samples/use-modules.pl         at line 8
    [ +516 =&gt;     3136] Exporter                                           from Carp                           at line 99
    [    0 =&gt;     3136] Config                                             from samples/use-modules.pl         at line 9
    [    0 =&gt;     3136] vars                                               from Config                         at line 11
    [  +32 =&gt;     3168] warnings::register                                 from vars                           at line 7
    [ +104 =&gt;     3272] Data::Dumper                                       from samples/use-modules.pl         at line 10
    [  +92 =&gt;     3364] XSLoader                                           from Data::Dumper                   at line 33
    [ +280 =&gt;     3644] constant                                           from Data::Dumper                   at line 277
    [+1028 =&gt;     4672] bytes                                              from Data::Dumper                   at line 754
    [  +24 =&gt;     4696] overload                                           from Data::Dumper                   at line 20
    [   +4 =&gt;     4700] overloading                                        from overload                       at line 83
    [  +76 =&gt;     4776] Digest                                             from samples/use-modules.pl         at line 11
    [  +28 =&gt;     4804] Encode                                             from samples/use-modules.pl         at line 12
    [   +8 =&gt;     4812] Encode::Alias                                      from Encode                         at line 47
    [ +536 =&gt;     5348] Encode::Config                                     from Encode                         at line 52
    [  +84 =&gt;     5432] Encode::Encoding                                   from Encode                         at line 265
    [  +24 =&gt;     5456] FindBin                                            from samples/use-modules.pl         at line 13
    [    0 =&gt;     5456] Cwd                                                from FindBin                        at line 83
    [ +448 =&gt;     5904] File::Basename                                     from FindBin                        at line 84
    [ +148 =&gt;     6052] File::Spec                                         from FindBin                        at line 85
    [  +12 =&gt;     6064] File::Spec::Unix                                   from File::Spec                     at line 22
    [ +268 =&gt;     6332] MyPackage                                          from samples/use-modules.pl         at line 15
    [   +4 =&gt;     6336] MultiplePackages                                   from samples/use-modules.pl         at line 16
    Use some CORE modules</code></pre>

<p>From there we can do some manual checking on the top modules and see if these are really required in the context of our program or if we can replace it with a less intrusive module... Most of the time you probably only care about modules used by your own code.</p>

<h3 id="Finding-unused-subroutines-using-PPI">Finding unused subroutines using PPI</h3>

<p>Now that we know that a module can brings dependencies, and these could use some extra memory, it would be nice to be able to detect if some of them are useless.</p>

<p>After some googling, I could quickly find a solution from brian d. foy: <a href="http://blogs.perl.org/users/brian_d_foy/2012/07/finding-unused-subroutines-but-with-ppi.html">Finding Unused Subroutines</a> which uses <a href="https://metacpan.org/module/PPI">PPI</a>.</p>

<p>PPI is a perl parser which tokenizes a source code to convert it to a list of &#39;tokens&#39; making any code manipulation easier than playing with regexp and other complex methods. After analyzing the document tree, you can add/remove/update some tokens (like for example comments, pods...), then later safely render it as a source code using the Lexer.</p>

<p>You can read more about PPI from its perldoc itself, where you could learn why it&#39;s called what it is: The two meanings for PPI are &quot;Parse::Perl::Isolated&quot; but also &#39;I Parse Perl&#39; (if you read it from right to left.)</p>

<p>Here is the main idea behind this PPI analysis:</p>

<p><ol> <li>Parse a script using PPI <li>get the list of all defined functions <li>get the list of all function used <ol> <li>can be a reference to the function: \&foo <li>direct call to function: foo() <li>find functions used as bareword: foo </ol> <li>do the diff between the two list to guess the unused functions </ol>

</p>



<p>brian d foy&#39;s solution is very smart, and works pretty well on small scripts.</p>

<p>Its main limitation comes from the fact that the analyze is only performed in the scope of your program. This can be solved by doing a fatpacking of your script. The second problem is that it should loop after removing functions as this could result in some extra optimizations. One way to do this is to perform the removal using PPI then perform a new analysis.</p>

<p>For example in this case, <code>c</code> is the function called which requires only <code>d</code> The algorithm described above will detect that <code>b</code> as a function is declared and never used but will not be able to do the same for <code>a</code> as it&#39;s used inside b.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!perl<br /></span><br /><span class="keyword">use</span> <span class="pragma">strict</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="pragma">warnings</span><span class="structure">;</span><br /><br /><span class="keyword">sub</span> <span class="word">a</span> <span class="structure">{}</span><br /><span class="keyword">sub</span> <span class="word">b</span> <span class="structure">{</span> <span class="word">a</span><span class="structure">()</span> <span class="structure">}</span><br /><span class="keyword">sub</span> <span class="word">c</span> <span class="structure">{</span> <span class="word">d</span><span class="structure">()</span> <span class="structure">}</span><br /><span class="keyword">sub</span> <span class="word">d</span> <span class="structure">{</span> <span class="number">1</span> <span class="structure">}</span><br /><br /><span class="word">c</span><span class="structure">();</span></code><br />&nbsp;</td></table>

<p>We could simply fix this by making iterative changes to the program, each time modifying it until we cannot remove any extra function or we reach a stable state, where nothing new needs to be removed.</p>

<p>Each iteration we re-perform an analysis on the updated document. This can be performed without writing the updated file to disk, but this allows an easier way to debug to write it each time. Since we write it out we can also add an extra check like a <code>perl -c</code> between each iteration to be sure we are not accidentally doing something bad.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment">#!perl<br /></span><br /><span class="comment"># this is a pseudo code<br /></span><br /><span class="keyword">my</span> <span class="symbol">$doc</span> <span class="operator">=</span> <span class="word">PPI::Document</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span> <span class="symbol">$script</span> <span class="structure">);</span><br /><span class="keyword">my</span> <span class="symbol">$step</span><span class="structure">;</span><br /><span class="keyword">while</span> <span class="structure">(</span> <span class="number">1</span> <span class="structure">)</span> <span class="structure">{</span> <span class="comment"># analyze required</span><br />&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">@remove_subs</span> <span class="operator">=</span> <span class="symbol">$doc</span><span class="operator">-&gt;</span><span class="word">remove_unused_subs</span><span class="structure">();</span><br />&nbsp;&nbsp;<span class="word">last</span> <span class="word">unless</span> <span class="word">scalar</span> <span class="symbol">@removed_subs</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">or</span> <span class="operator">!</span><span class="word">cmp_bag</span><span class="structure">(</span><span class="cast">\</span><span class="symbol">@removed_subs</span><span class="operator">,</span> <span class="cast">\</span><span class="symbol">@previous_state</span><span class="structure">);</span><br />&nbsp;&nbsp;<span class="symbol">@previous_state</span> <span class="operator">=</span> <span class="symbol">@remove_subs</span><span class="structure">;</span><br />&nbsp;&nbsp;<span class="operator">++</span><span class="symbol">$step</span><span class="structure">;</span><br />&nbsp;&nbsp;<span class="symbol">$doc</span><span class="operator">-&gt;</span><span class="word">update_and_write_to</span><span class="structure">(</span> <span class="double">&quot;$script.step-$step&quot;</span> <span class="structure">);</span><br /><span class="comment">  # reread the file<br /></span>  <span class="symbol">$doc</span> <span class="operator">=</span> <span class="word">PPI::Document</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span> <span class="double">&quot;$script.step-$step&quot;</span> <span class="structure">);</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<h4 id="basic-modulino-to-play-with-PPI">basic modulino to play with PPI</h4>

<p>Let&#39;s try to package this in Object Oriented way, and give it a try with a program that could strip comments and pods from a script</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;<br />42:&nbsp;<br />43:&nbsp;<br />44:&nbsp;<br />45:&nbsp;<br />46:&nbsp;<br />47:&nbsp;<br />48:&nbsp;<br />49:&nbsp;<br />50:&nbsp;<br />51:&nbsp;<br />52:&nbsp;<br />53:&nbsp;<br />54:&nbsp;<br />55:&nbsp;<br />56:&nbsp;<br />57:&nbsp;<br />58:&nbsp;<br />59:&nbsp;<br />60:&nbsp;<br />61:&nbsp;<br />62:&nbsp;<br />63:&nbsp;<br />64:&nbsp;<br />65:&nbsp;<br />66:&nbsp;<br />67:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Analyze</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">PPI</span><span class="structure">;</span><br /><span class="comment"># similar to using Moo here, but in one line with no other<br />#  deps (just need lazy builders and accessors)<br /></span><span class="keyword">use</span> <span class="word">Simple::Accessor</span> <span class="words">qw{<br />&nbsp;&nbsp;&nbsp;Document content subs symbols list barewords<br />&nbsp;&nbsp;methods packages<br />}</span><span class="structure">;</span><br /><br /><span class="keyword">sub</span> <span class="word">_build_Document</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span><span class="symbol">$self</span><span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">die</span> <span class="word">unless</span> <span class="word">ref</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">content</span> <span class="operator">eq</span> <span class="single">'SCALAR'</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">or</span> <span class="operator">-f</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">content</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$Document</span> <span class="operator">=</span> <span class="word">PPI::Document</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">content</span> <span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">die</span> <span class="double">&quot;Could not create PDOM!&quot;</span> <span class="word">unless</span> <span class="word">ref</span> <span class="symbol">$Document</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$Document</span><span class="structure">;</span><br /><span class="structure">}</span><br /><br /><span class="keyword">sub</span> <span class="word">stringify</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$self</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">Document</span><span class="operator">-&gt;</span><span class="word">serialize</span><span class="structure">;</span><br /><span class="structure">}</span><br /><br /><span class="comment"># PPI::Token::Comment<br /></span><br /><span class="keyword">sub</span> <span class="word">remove_pods</span> <span class="structure">{</span><br />&nbsp;&nbsp;<span class="magic">$_</span><span class="structure">[</span><span class="number">0</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="word">remove_tokens</span><span class="structure">(</span><span class="single">'PPI::Token::Pod'</span><span class="structure">)</span><br /><span class="structure">}</span><br /><br /><span class="keyword">sub</span> <span class="word">remove_comments</span> <span class="structure">{</span><br />&nbsp;&nbsp;<span class="magic">$_</span><span class="structure">[</span><span class="number">0</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="word">remove_tokens</span><span class="structure">(</span><span class="single">'PPI::Token::Comment'</span><span class="structure">)</span><br /><span class="structure">}</span><br /><br /><span class="keyword">sub</span> <span class="word">remove_tokens</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span> <span class="symbol">$self</span><span class="operator">,</span> <span class="symbol">$token</span> <span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$pods</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">Document</span><span class="operator">-&gt;</span><span class="word">find</span><span class="structure">(</span><span class="symbol">$token</span><span class="structure">)</span> <span class="operator">||</span> <span class="structure">[];</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">foreach</span> <span class="keyword">my</span> <span class="symbol">$pod</span> <span class="structure">(</span><span class="cast">@</span><span class="symbol">$pods</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$pod</span><span class="operator">-&gt;</span><span class="word">delete</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span class="structure">;</span><br /><span class="structure">}</span><br /><br /><span class="keyword">package</span> <span class="word">main</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="version">v5.014</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">File::Slurp</span> <span class="words">qw{read_file write_file}</span><span class="structure">;</span><br /><br /><span class="word">exit</span> <span class="word">run</span><span class="structure">(</span><span class="symbol">@ARGV</span><span class="structure">)</span> <span class="word">unless</span> <span class="word">caller</span><span class="structure">;</span><br /><br /><span class="keyword">sub</span> <span class="word">run</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$script</span> <span class="operator">=</span> <span class="core">shift</span> <span class="operator">or</span> <span class="word">die</span> <span class="double">&quot;Missing argument script name to analyze&quot;</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$content</span> <span class="operator">=</span> <span class="word">read_file</span><span class="structure">(</span><span class="symbol">$script</span><span class="structure">)</span> <span class="operator">or</span> <span class="word">die</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$analyze</span> <span class="operator">=</span> <span class="word">Analyze</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span> <span class="word">content</span> <span class="operator">=&gt;</span> <span class="cast">\</span><span class="symbol">$content</span> <span class="structure">);</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$analyze</span><span class="operator">-&gt;</span><span class="word">remove_pods</span><span class="structure">();</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$analyze</span><span class="operator">-&gt;</span><span class="word">remove_comments</span><span class="structure">();</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$updated</span> <span class="operator">=</span> <span class="double">&quot;$script.updated&quot;</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">write_file</span><span class="structure">(</span> <span class="symbol">$updated</span><span class="operator">,</span> <span class="symbol">$analyze</span><span class="operator">-&gt;</span><span class="word">stringify</span> <span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">say</span> <span class="double">&quot;Write updated version to '$updated&quot;</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="number">0</span><span class="structure">;</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>When used like this, a new file is going to be written on disk where all comments and pod are stripped. You can test it by yourself.</p>

<pre><code>    &gt; perl strip-comments-and-pods.pl script.pl
    Write updated version to &#39;script.pl.updated</code></pre>

<h4 id="PPI-how-to-get-the-list-of-functions-defined">PPI how to get the list of functions defined</h4>

<p>A function is described in PPI by a &#39;PPI::Statement::Sub&#39;, we should exclude from this list the reserved one like BEGIN, CHECK...</p>

<p>Note: this code is extending the previous packages described above.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Analyze</span><span class="structure">;</span><br /><br /><span class="operator">...</span><br /><span class="comment"># Get all of the subroutine definitions<br /></span><span class="keyword">sub</span> <span class="word">_build_subs</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$self</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">%subs</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$all_ppi_subs</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">Document</span><span class="operator">-&gt;</span><span class="word">find</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="magic">$_</span><span class="structure">[</span><span class="number">1</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="word">isa</span><span class="structure">(</span><span class="single">'PPI::Statement::Sub'</span><span class="structure">)</span><br /><span class="comment">              # not a BEGIN, CHECK, UNITCHECK, INIT and END,<br /></span>              <span class="operator">&amp;&amp;</span> <span class="operator">!</span><span class="magic">$_</span><span class="structure">[</span><span class="number">1</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="word">reserved</span><span class="structure">()</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">)</span> <span class="operator">||</span> <span class="structure">[];</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">foreach</span> <span class="keyword">my</span> <span class="symbol">$sub</span> <span class="structure">(</span><span class="cast">@</span><span class="symbol">$all_ppi_subs</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$name</span> <span class="operator">=</span> <span class="symbol">$sub</span><span class="operator">-&gt;</span><span class="word">name</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$subs</span><span class="structure">{</span><span class="symbol">$name</span><span class="structure">}</span> <span class="operator">=</span> <span class="symbol">$sub</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">debug</span> <span class="double">&quot;* All sub definitions: &quot;</span><span class="operator">,</span> <span class="word">sort</span> <span class="word">keys</span> <span class="symbol">%subs</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="cast">\</span><span class="symbol">%subs</span><span class="structure">;</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>This is good but the problem here is that these two functions will have the same name...</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">Foo</span><span class="structure">;</span> <span class="keyword">sub</span> <span class="word">hello</span> <span class="structure">{</span> <span class="structure">}</span><br /><span class="keyword">package</span> <span class="word">Bar</span><span class="structure">;</span> <span class="keyword">sub</span> <span class="word">hello</span> <span class="structure">{</span> <span class="structure">}</span></code><br />&nbsp;</td></table>

<p>So we would like to know in which package the function is defined, then use its fullname Foo::hello, Bar::hello or main::hello.</p>

<h4 id="PPI-getting-the-package-name-of-a-function">PPI getting the package name of a function</h4>

<p>We need a way to get the package name from a PPI element</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">my</span> <span class="symbol">$namespace</span> <span class="operator">=</span> <span class="word">eval</span> <span class="structure">{</span><br />&nbsp;&nbsp;<span class="symbol">$elt</span><span class="operator">-&gt;</span><span class="word">parent</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">find_first</span><span class="structure">(</span><span class="single">'PPI::Statement::Package'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">namespace</span><br /><span class="structure">};</span></code><br />&nbsp;</td></table>

<p>In some cases this unfortunately does not provide the information we would expect. In order to get this to work we need to create a workaround to save the begin and end line for each packages so it will be easy to know where a function is located if we can know on which line it was defined.</p>

<p>Let&#39;s add an attribute &#39;packages&#39; to the Analyze class and save the start and end line for each package. (note that a package namespace can be use more than once )</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment"># do not cache the value as when removing a doc,<br /># cache needs to be cleared<br /></span><span class="keyword">sub</span> <span class="word">_build_packages</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$self</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br /><br /><span class="comment">    # use an array and not a hash as a package (like main or<br />&nbsp;&nbsp;&nbsp;&nbsp;# any other) can be defined multiple times<br /></span>    <span class="keyword">my</span> <span class="symbol">@packages</span><span class="structure">;</span><br /><br /><span class="comment">    # find return the elements sorted<br /></span>    <span class="keyword">my</span> <span class="symbol">$search</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">Document</span><span class="operator">-&gt;</span><span class="word">find</span><span class="structure">(</span><span class="single">'PPI::Statement::Package'</span><span class="structure">)</span> <span class="operator">||</span> <span class="structure">[];</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">foreach</span> <span class="keyword">my</span> <span class="symbol">$pkg</span> <span class="structure">(</span><span class="cast">@</span><span class="symbol">$search</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> <span class="structure">(</span> <span class="word">scalar</span> <span class="symbol">@packages</span> <span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$packages</span><span class="structure">[</span><span class="number">-1</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="single">'to'</span><span class="structure">}</span> <span class="operator">=</span> <span class="symbol">$pkg</span><span class="operator">-&gt;</span><span class="word">line_number</span> <span class="operator">-</span> <span class="number">1</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">push</span> <span class="symbol">@packages</span><span class="operator">,</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">name</span>        <span class="operator">=&gt;</span> <span class="symbol">$pkg</span><span class="operator">-&gt;</span><span class="word">namespace</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">from</span>        <span class="operator">=&gt;</span> <span class="symbol">$pkg</span><span class="operator">-&gt;</span><span class="word">line_number</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">to</span>          <span class="operator">=&gt;</span> <span class="number">0</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">file_scoped</span> <span class="operator">=&gt;</span> <span class="symbol">$pkg</span><span class="operator">-&gt;</span><span class="word">file_scoped</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">};</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="cast">\</span><span class="symbol">@packages</span><span class="structure">;</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>Now that we have that information it becomes easy to know in which namespace the function was declared. Rather than using <code>$sub-&gt;name</code> we could use <code>get_package_for($sub)</code> with the following</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">sub</span> <span class="word">get_package_for</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span> <span class="symbol">$self</span><span class="operator">,</span> <span class="symbol">$elt</span> <span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$line</span>         <span class="operator">=</span> <span class="symbol">$elt</span><span class="operator">-&gt;</span><span class="word">line_number</span><span class="structure">;</span><br /><br /><span class="comment">    # coming from previous function _build_packages<br /></span>    <span class="keyword">my</span> <span class="symbol">$all_packages</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">packages</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">foreach</span> <span class="keyword">my</span> <span class="symbol">$v</span> <span class="structure">(</span><span class="cast">@</span><span class="symbol">$all_packages</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$pkg</span> <span class="operator">=</span> <span class="symbol">$v</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">name</span><span class="structure">};</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> <span class="structure">(</span> <span class="symbol">$v</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">from</span><span class="structure">}</span> <span class="operator">&lt;</span> <span class="symbol">$line</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">&amp;&amp;</span> <span class="structure">(</span> <span class="symbol">$v</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">to</span><span class="structure">}</span> <span class="operator">==</span> <span class="number">0</span> <span class="operator">||</span> <span class="symbol">$line</span> <span class="operator">&lt;=</span> <span class="symbol">$v</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">to</span><span class="structure">}</span> <span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$pkg</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="single">'main'</span><span class="structure">;</span> <span class="comment"># default</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<h4 id="PPI-get-list-of-methods-used-as-function-call">PPI get list of methods used as function call</h4>

<p>If your script is using object oriented style, then you will quickly have function calls instead of method calls: <code>$object-&gt;foo()</code> rather than <code>foo()</code></p>

<p>We cannot do anything for something like <code>$object-&gt;$foo()</code>, but we can try to check all static function calls trying to find the PPI::Token::Operator <code>-&gt;</code></p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment"># list of methods with the scope where they might be used<br /></span><span class="keyword">sub</span> <span class="word">_build_methods</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$self</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">@methods</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$search</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">Document</span><span class="operator">-&gt;</span><span class="word">find</span><span class="structure">(</span><span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="magic">$_</span><span class="structure">[</span><span class="number">1</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="word">isa</span><span class="structure">(</span><span class="single">'PPI::Token::Operator'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">&amp;&amp;</span> <span class="magic">$_</span><span class="structure">[</span><span class="number">1</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="word">content</span> <span class="operator">eq</span> <span class="single">'-&gt;'</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">})</span> <span class="operator">||</span> <span class="structure">[];</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">foreach</span> <span class="keyword">my</span> <span class="symbol">$op</span> <span class="structure">(</span><span class="cast">@</span><span class="symbol">$search</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">next</span> <span class="word">unless</span> <span class="word">eval</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$op</span><span class="operator">-&gt;</span><span class="word">snext_sibling</span><span class="operator">-&gt;</span><span class="word">class</span> <span class="operator">eq</span> <span class="single">'PPI::Token::Word'</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">};</span><br /><br /><span class="comment">        # maybe something special for nw ?<br /></span>        <span class="word">push</span> <span class="symbol">@methods</span><span class="operator">,</span> <span class="symbol">$op</span><span class="operator">-&gt;</span><span class="word">snext_sibling</span><span class="operator">-&gt;</span><span class="word">content</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">debug</span> <span class="double">&quot;* All methods: &quot;</span><span class="operator">,</span> <span class="word">sort</span> <span class="symbol">@methods</span><span class="structure">;</span><br /><br /><span class="comment">    #note explain $all_statements;<br /></span>    <span class="keyword">return</span> <span class="cast">\</span><span class="symbol">@methods</span><span class="structure">;</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<h4 id="PPI-detect-function-used-as-reference-or-stash">PPI detect function used as reference or stash</h4>

<p>We can get the list of symbols, functions not called with parens but with &amp;foo, \&amp;foo, *foo...</p>

<p>The code is not much more complex than finding defined functions.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #<br /># find the sub calls that use &amp;<br /># &amp;foo<br /># &amp;foo()<br /># \&amp;foo<br /># *foo<br /></span><span class="keyword">sub</span> <span class="word">_build_symbols</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$self</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">@symbols</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$search</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">Document</span><span class="operator">-&gt;</span><span class="word">find</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="magic">$_</span><span class="structure">[</span><span class="number">1</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="word">isa</span><span class="structure">(</span><span class="single">'PPI::Token::Symbol'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">&amp;&amp;</span> <span class="structure">(</span> <span class="magic">$_</span><span class="structure">[</span><span class="number">1</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="word">symbol_type</span> <span class="operator">eq</span> <span class="single">'&amp;'</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">||</span> <span class="magic">$_</span><span class="structure">[</span><span class="number">1</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="word">symbol_type</span> <span class="operator">eq</span> <span class="single">'*'</span> <span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">)</span> <span class="operator">||</span> <span class="structure">[];</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">foreach</span> <span class="keyword">my</span> <span class="symbol">$elt</span> <span class="structure">(</span><span class="cast">@</span><span class="symbol">$search</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$name</span> <span class="operator">=</span> <span class="symbol">$elt</span><span class="operator">-&gt;</span><span class="word">content</span> <span class="operator">=~</span> <span class="substitute">s/\A[&amp;*]//r</span><span class="structure">;</span>    <span class="comment"># /</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> <span class="structure">(</span> <span class="symbol">$name</span> <span class="operator">!~</span> <span class="regexp">qr{::}</span> <span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$name</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">get_package_for</span><span class="structure">(</span><span class="symbol">$elt</span><span class="structure">)</span> <span class="operator">.</span> <span class="single">'::'</span> <span class="operator">.</span> <span class="symbol">$name</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">push</span> <span class="symbol">@symbols</span><span class="operator">,</span> <span class="symbol">$name</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">@symbols</span> <span class="operator">=</span> <span class="word">sort</span> <span class="symbol">@symbols</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">debug</span> <span class="double">&quot;* All symbols: @symbols&quot;</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="cast">\</span><span class="symbol">@symbols</span><span class="structure">;</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<h4 id="PPI-find-the-sub-calls-that-use-parens">PPI find the sub calls that use parens</h4>

<p>Building the list of function called with some parens isn&#39;t more complex than listing all defined functions. We simply need to find a &#39;Token::Word&#39; followed by an open paren.</p>

<p>The following code tries to get the fullname of the function depending if it&#39;s called as <code>foo()</code> or <code>Bar::foo()</code></p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #<br /># find the sub calls that use parens<br /># foo()<br />#   foo( @args )<br /></span><span class="keyword">sub</span> <span class="word">_build_list</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$self</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">@list</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$search</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">Document</span><span class="operator">-&gt;</span><span class="word">find</span><span class="structure">(</span><span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="magic">$_</span><span class="structure">[</span><span class="number">1</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="word">isa</span><span class="structure">(</span><span class="single">'PPI::Token::Word'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">&amp;&amp;</span> <span class="magic">$_</span><span class="structure">[</span><span class="number">1</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="word">snext_sibling</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">&amp;&amp;</span> <span class="magic">$_</span><span class="structure">[</span><span class="number">1</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="word">snext_sibling</span><span class="operator">-&gt;</span><span class="word">isa</span><span class="structure">(</span><span class="single">'PPI::Structure::List'</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">})</span> <span class="operator">||</span> <span class="structure">[];</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">foreach</span> <span class="keyword">my</span> <span class="symbol">$elt</span> <span class="structure">(</span><span class="cast">@</span><span class="symbol">$search</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$name</span> <span class="operator">=</span> <span class="symbol">$elt</span><span class="operator">-&gt;</span><span class="word">literal</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> <span class="structure">(</span> <span class="symbol">$name</span> <span class="operator">!~</span> <span class="regexp">qr{::}</span> <span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$name</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">get_package_for</span><span class="structure">(</span><span class="symbol">$elt</span><span class="structure">)</span> <span class="operator">.</span> <span class="single">'::'</span> <span class="operator">.</span> <span class="symbol">$name</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">push</span> <span class="symbol">@list</span><span class="operator">,</span> <span class="symbol">$name</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">debug</span> <span class="double">&quot;* All list: @list&quot;</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="cast">\</span><span class="symbol">@list</span><span class="structure">;</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<h4 id="PPI-find-the-sub-calls-that-are-barewords">PPI find the sub calls that are barewords</h4>

<p>In a very similar way we can also build the list of functions used as barewords.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;<br />42:&nbsp;<br />43:&nbsp;<br />44:&nbsp;<br />45:&nbsp;<br />46:&nbsp;<br />47:&nbsp;<br />48:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="comment"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #<br /># find the sub calls that are barewords<br /># foo<br /># foo + bar<br /># but not<br /># use vars qw( baz );<br /># sub quux { ... }<br /></span><span class="keyword">sub</span> <span class="word">_build_barewords</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$self</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">%reserved</span> <span class="operator">=</span> <span class="word">map</span> <span class="structure">{</span> <span class="magic">$_</span><span class="operator">,</span> <span class="magic">$_</span> <span class="structure">}</span> <span class="words">qw(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;use vars sub my BEGIN INIT new<br />&nbsp;&nbsp;&nbsp;&nbsp;)</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">@barewords</span> <span class="operator">=</span> <span class="word">map</span> <span class="structure">{</span> <span class="magic">$_</span><span class="operator">-&gt;</span><span class="word">literal</span> <span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">grep</span> <span class="structure">{</span><br /><span class="comment">        # Take out the Words that are preceded by 'sub'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# That is, take out the subroutine definitions<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# I couldn't get this to work inside the find()<br /></span>        <span class="keyword">my</span> <span class="symbol">$previous</span>  <span class="operator">=</span> <span class="magic">$_</span><span class="operator">-&gt;</span><span class="word">previous_sibling</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$sprevious</span> <span class="operator">=</span> <span class="magic">$_</span><span class="operator">-&gt;</span><span class="word">sprevious_sibling</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">!</span><span class="structure">(</span> <span class="word">blessed</span><span class="structure">(</span><span class="symbol">$previous</span><span class="structure">)</span> <span class="operator">&amp;&amp;</span> <span class="word">blessed</span><span class="structure">(</span><span class="symbol">$sprevious</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">&amp;&amp;</span> <span class="symbol">$previous</span><span class="operator">-&gt;</span><span class="word">isa</span><span class="structure">(</span><span class="single">'PPI::Token::Whitespace'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">&amp;&amp;</span> <span class="symbol">$sprevious</span><span class="operator">-&gt;</span><span class="word">isa</span><span class="structure">(</span><span class="single">'PPI::Token::Word'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">&amp;&amp;</span> <span class="symbol">$sprevious</span><span class="operator">-&gt;</span><span class="word">literal</span> <span class="operator">eq</span> <span class="single">'sub'</span> <span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span> <span class="cast">@</span><span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">Document</span><span class="operator">-&gt;</span><span class="word">find</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="magic">$_</span><span class="structure">[</span><span class="number">1</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="word">isa</span><span class="structure">(</span><span class="single">'PPI::Token::Word'</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">&amp;&amp;</span> <span class="magic">$_</span><span class="structure">[</span><span class="number">1</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="word">next_sibling</span><span class="operator">-&gt;</span><span class="word">isa</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="words">qw(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PPI::Token::Whitespace<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PPI::Token::Structure<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PPI::Token::List<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PPI::Token::Operator<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">)</span> <span class="operator">&amp;&amp;</span> <span class="structure">(</span> <span class="operator">!</span><span class="word">exists</span> <span class="symbol">$reserved</span><span class="structure">{</span> <span class="magic">$_</span><span class="structure">[</span><span class="number">1</span><span class="structure">]</span><span class="operator">-&gt;</span><span class="word">literal</span> <span class="structure">}</span> <span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">||</span> <span class="structure">[]</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">};</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">debug</span> <span class="double">&quot;* All barewords: @barewords&quot;</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">push</span> <span class="symbol">@barewords</span><span class="operator">,</span> <span class="word">sort</span> <span class="word">keys</span> <span class="symbol">%reserved</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="cast">\</span><span class="symbol">@barewords</span><span class="structure">;</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<h3 id="Combining-everything-togeteher">Combining everything togeteher</h3>

<p>While we can now list used and defined functions, we still need a few extra helpers around it to make it useful.</p>

<h4 id="Get-the-list-of-used-functions">Get the list of used functions</h4>

<p>Getting the list of all used functions then become very easy, we just need to combine, symbols, list and barewords.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">sub</span> <span class="word">get_used_sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$self</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$symbols</span>   <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">symbols</span>   <span class="operator">//</span> <span class="structure">[];</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$list</span>      <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">list</span>      <span class="operator">//</span> <span class="structure">[];</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$barewords</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">barewords</span> <span class="operator">//</span> <span class="structure">[];</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">%used</span> <span class="operator">=</span> <span class="word">map</span> <span class="structure">{</span> <span class="magic">$_</span> <span class="operator">=&gt;</span> <span class="number">1</span> <span class="structure">}</span> <span class="structure">(</span> <span class="cast">@</span><span class="symbol">$symbols</span><span class="operator">,</span> <span class="cast">@</span><span class="symbol">$list</span><span class="operator">,</span> <span class="cast">@</span><span class="symbol">$barewords</span> <span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">debug</span> <span class="double">&quot;* All used:&quot;</span><span class="operator">,</span> <span class="word">map</span> <span class="structure">{</span> <span class="structure">(</span> <span class="single">' '</span><span class="operator">,</span> <span class="magic">$_</span> <span class="structure">)</span> <span class="structure">}</span> <span class="word">sort</span> <span class="cast">@</span><span class="structure">{</span> <span class="structure">[</span> <span class="word">keys</span> <span class="symbol">%used</span> <span class="structure">]</span> <span class="structure">};</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="cast">\</span><span class="symbol">%used</span><span class="structure">;</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>We also need an additional helper to check if a function is used as a method call</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">sub</span> <span class="word">is_used_method</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span> <span class="symbol">$self</span><span class="operator">,</span> <span class="symbol">$sub</span> <span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$methods</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">methods</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">scalar</span> <span class="word">grep</span> <span class="structure">{</span> <span class="symbol">$sub</span> <span class="operator">=~</span> <span class="regexp">qr{::$_$}</span> <span class="structure">}</span> <span class="cast">@</span><span class="symbol">$methods</span><span class="structure">;</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<h4 id="Removing-unused-functions">Removing unused functions</h4>

<p>So all we need to do after creating a PPI doc using the Analyze module is ask:</p>

<ul>

<li><p>what are the defined functions</p>

</li>
<li><p>what are the used functions</p>

</li>
<li><p>remove any defined function which is not used or not used a as a method</p>

</li>
<li><p>delete the function from the PPI tree (except if it&#39;s blacklisted)</p>

</li>
</ul>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">sub</span> <span class="word">remove_unused_subs</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$self</span> <span class="operator">=</span> <span class="core">shift</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$subs</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">subs</span><span class="structure">;</span>           <span class="comment"># all subs</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$used</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">get_used_sub</span><span class="structure">;</span><br /><br /><span class="comment">    # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #<br />&nbsp;&nbsp;&nbsp;&nbsp;# The unused have to be the left over ones<br />&nbsp;&nbsp;&nbsp;&nbsp;# exception for methods:<br />&nbsp;&nbsp;&nbsp;&nbsp;#   if a method is called on any object do not remove the<br />&nbsp;&nbsp;&nbsp;&nbsp;#   function (can be improve for new &amp; co)<br /></span>    <span class="keyword">my</span> <span class="symbol">@unused</span> <span class="operator">=</span> <span class="word">sort</span> <span class="word">grep</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">!</span><span class="word">exists</span> <span class="symbol">$used</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="magic">$_</span><span class="structure">}</span> <span class="operator">&amp;&amp;</span> <span class="operator">!</span><span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">is_used_method</span><span class="structure">(</span><span class="magic">$_</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span> <span class="word">keys</span> <span class="cast">%</span><span class="symbol">$subs</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">debug</span> <span class="double">&quot;* All unused: @unused&quot;</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">@removed</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">foreach</span> <span class="keyword">my</span> <span class="symbol">$sub</span> <span class="structure">(</span><span class="symbol">@unused</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">next</span> <span class="word">if</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">is_blacklist_sub</span><span class="structure">(</span><span class="symbol">$sub</span><span class="structure">);</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> <span class="structure">(</span> <span class="operator">!</span><span class="core">defined</span> <span class="symbol">$subs</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="symbol">$sub</span><span class="structure">}</span> <span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">debug</span> <span class="double">&quot;error: sub '$sub' not defined&quot;</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">next</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$subs</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="symbol">$sub</span><span class="structure">}</span><span class="operator">-&gt;</span><span class="word">delete</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">push</span> <span class="symbol">@removed</span><span class="operator">,</span> <span class="symbol">$sub</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><br /><span class="comment">    # return removed sub list<br /></span>    <span class="keyword">return</span> <span class="symbol">@removed</span><span class="structure">;</span><br /><span class="structure">}</span> </code><br />&nbsp;</td></table>

<h3 id="In-Conclusion">In Conclusion</h3>

<p>We&#39;ve seen in the first part that each module comes with its own memory cost. In the second part we can now remove unused functions from a script, after fatpacking it. Even if in some cases the result script works this should probably still mainly be used as advice on how to refactor your code.</p>

<p>Detecting dead code with static analysis is prone to errors due to the dynamic nature of perl. <code>$function()</code> or <code>$object-&gt;$method()...</code> As this could potentially come from the current ENV we have no accurate way to perform a safe removal.</p>

<p>This method comes with its own limits, as it&#39;s performed as a static analysis. Another very interesting approach to this problem would be to analyze what happens at run time! and see what code paths are triggered in the life (minutes, hours, weeks...) of a program. And this is exactly what is done by Gonzalo via Devel::QuickCover.</p>

<p>You can play with the scripts described here available from the github repository. They are in a quick&amp;dirty mode, and could be improved in many ways but can still provide a first approach to play with PPI.</p>

<h2 id="SEE-ALSO">SEE ALSO</h2>

<ul>

<li><p><a href="https://metacpan.org/module/PPI">PPI</a></p>

</li>
<li><p><a href="http://blogs.perl.org/users/brian_d_foy/2012/07/finding-unused-subroutines-but-with-ppi.html">brian d foy, Finding Unused Subroutines, but with PPI</a></p>

</li>
<li><p><a href="https://www.youtube.com/watch?v=7EbLC3M5n6g">Gonzalo Diethelm, Finding dead code, the quick and easy way, with Devel::QuickCover</a></p>

</li>
<li><p><a href="https://youtu.be/AMa1JWgG4yY">@atoomic, TPC 2016 Video on YouTube</a></p>

</li>
<li><p><a href="http://bit.do/b7N79">TPC 2016 slides</a></p>

</li>
<li><p><a href="https://github.com/atoomic/yapc-na-2016">github repo</a></p>

</li>
</ul>



</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/7df78e735b7ef916d691e0b574a14f06?r=g&s=80&d=retro />
This article contributed by: Nicolas R. &lt;atoomic@cpan.org&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Getting Drunk with Mojolicious and Memoize" href="2016-12-13.html">Previous</a></li>

    <li class="next"><a title="Making Perl Functional" href="2016-12-15.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-27056407-1");
pageTracker._trackPageview();
} catch(err) {}</script>
</body>
</html>





