<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.113" />
    <link rel="alternate" title="Perl Advent Calendar 2016 XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link rel="stylesheet" href="2016.css" type="text/css" />
    <title>
Perl Advent Calendar 2016 - 
Help Santa Klaus Reward Only Nice Children

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">Perl Advent Calendar 2016</a></h1>
        </div>

        <p id="tagline">2016 twenty four merry days of Perl
         <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>Help Santa Klaus Reward Only Nice Children</h1>
<div class='subtitle'>Schedule::LongSteps - 2016-12-06</div>

<div class='pod'><h3 id="Once-Upon-A-Time">Once Upon A Time</h3>

<p>It&#39;s 2016, and near the North Pole in Scotland, Santa Klaus is having his annual financial review. And it doesn&#39;t look great.</p>

<p>Santa realises he needs to reduce his costs from now on, and so decides to only reward children who have been nice throughout the year, as opposed to lavishly rewarding even the naughty ones as he&#39;s done for decades past.</p>

<p>After consulting with the senior elves, Santa decides to implement a child niceness assessment process over the year:</p>

<dl>

<dt>In February, all parents receive a letter from Santa including a report form for them to fill in.</dt>
<dd>

</dd>
<dt>The due date for the report form is the 1st of November.</dt>
<dd>

</dd>
<dt>If no form has been received, the child is considered naughty.</dt>
<dd>

</dd>
<dt>Each completed form is assigned to an elf for assessment (the assessment process is another story).</dt>
<dd>

</dd>
</dl>

<p>Santa&#39;s elves are not very enthusiastic about implementing this in Perl, with all the code required to track if the parents have filled in the forms or not and building the logic to trigger the right part of their existing code base at the right time. How do they design these processes so to minimize the mess? How will they unit test that so things don&#39;t randomly fail in the future?</p>

<p>&#39;Stop panicking!&#39; says Rudolf, head of Santa&#39;s programming sweatshop. &#39;I&#39;ve found <a href="https://metacpan.org/module/Schedule::LongSteps">Schedule::LongSteps</a> on the CPAN!&#39;</p>

<p><a href="https://metacpan.org/module/Schedule::LongSteps">Schedule::LongSteps</a> is a small framework that enables you to program the future with confidence.</p>

<h2 id="Lets-Help-Santa-Implement">Let&#39;s Help Santa Implement!</h2>

<p>For this example implementation, we&#39;ll assume we have an object <code>$santaHQ</code> that represents Santa&#39;s business and all the wonderful things it can do. We&#39;re going to concentrate on creating example module that manages the process spelled out above.</p>

<p>In <a href="https://metacpan.org/module/Schedule::LongSteps">Schedule::LongSteps</a>, the process we are modeling is simply modeled as a class that extends Schedule::LongSteps:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">My::Process::NicenessFeedback</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">Moose</span><span class="structure">;</span> <span class="comment"># There are a lot of them in Santa's land.</span><br /><span class="word">extends</span> <span class="words">qw/Schedule::LongSteps/</span><span class="structure">;</span><br /><br /><span class="comment"># The object that represents all the business logic that this process<br /># model operates on<br /></span><span class="word">has</span> <span class="single">'santaHQ'</span> <span class="operator">=&gt;</span> <span class="structure">(</span> <span class="word">is</span> <span class="operator">=&gt;</span> <span class="single">'ro'</span><span class="operator">,</span> <span class="word">isa</span> <span class="operator">=&gt;</span> <span class="single">'My::SantaHQ'</span><span class="operator">,</span> <span class="word">required</span> <span class="operator">=&gt;</span> <span class="number">1</span> <span class="structure">);</span><br /><br /><span class="word">__PACKAGE__</span><span class="operator">-&gt;</span><span class="word">meta</span><span class="operator">-&gt;</span><span class="word">make_immutable</span><span class="structure">();</span><br /><span class="number">1</span><span class="structure">;</span></code><br />&nbsp;</td></table>

<p>Each actual process model is an instance of this that maintains a state. The state of the process serves both as the place to give the process parameters and the place that stores the current work in progress. It must only contain &#39;pure Perl&#39; data, so no objects.</p>

<p>Schedule::LongSteps stores this state between executions of the code in what is known as a Storage. This pluggable storage system allows Schedule::LongSteps to store data for you in various ways, typically in a SQL database.</p>

<p>Before we flesh out the My::Process::NicenessFeedback module, let&#39;s look at how we might instantiate it with the Schedule::LongSteps module:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">my</span> <span class="symbol">$sl</span> <span class="operator">=</span> <span class="word">Schedule::LongSteps</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">();</span><br /><br /><span class="symbol">$sl</span><span class="operator">-&gt;</span><span class="word">instantiate_process</span><span class="structure">(</span><br />&nbsp;&nbsp;<span class="single">'My::Process::NicenessFeedback'</span><span class="operator">,</span><br />&nbsp;&nbsp;<span class="structure">{</span> <span class="word">santaHQ</span> <span class="operator">=&gt;</span> <span class="symbol">$santaHQ</span> <span class="structure">}</span><span class="operator">,</span>  <span class="comment"># The construction parameters</span><br />&nbsp;&nbsp;<span class="structure">{</span> <span class="word">child_id</span> <span class="operator">=&gt;</span> <span class="number">1234</span> <span class="structure">}</span>      <span class="comment"># Initial state</span><br /><span class="structure">);</span></code><br />&nbsp;</td></table>

<p>We&#39;ve passed in two hash refs. The first is the parameters that need to be passed to My::Process::NicenessFeedback when Schedule::LongSteps instantiates it - in this case the <code>$santaHQ</code> that holds all of our underlying business logic. The second hashref contains the initial state we want to assign to the object.</p>

<p>This state will be accessible inside our object using the <code>state</code> method, and while the state has to be a pure Perl data structure we can use builder methods to populate attributes with more complex objects:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">package</span> <span class="word">My::Process::NicenessFeedback</span><span class="structure">;</span><br /><span class="operator">...</span><br /><span class="word">has</span> <span class="single">'child'</span> <span class="operator">=&gt;</span> <span class="structure">(</span> <span class="word">is</span> <span class="operator">=&gt;</span> <span class="single">'ro'</span><span class="operator">,</span> <span class="word">lazy_build</span> <span class="operator">=&gt;</span> <span class="number">1</span> <span class="structure">);</span><br /><span class="keyword">sub</span> <span class="word">_build_child</span><span class="structure">{</span><br />&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span><span class="symbol">$self</span><span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br />&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">santaHQ</span><span class="structure">()</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">big_book_of_children</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">find</span><span class="structure">(</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">state</span><span class="structure">()</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">child_id</span><span class="structure">}</span> <span class="structure">);</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>The process now has a child!</p>

<h3 id="Adding-Steps">Adding Steps!</h3>

<p>We can now define what it should do first. For this, we first implement the (mandatory) method &#39;build_first_step&#39; method:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">sub</span> <span class="word">build_first_step</span><span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span><span class="symbol">$self</span><span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br /><span class="comment">    # At the beginning of February next year<br />&nbsp;&nbsp;&nbsp;&nbsp;# send the parents a form.<br /></span>    <span class="keyword">return</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">new_step</span><span class="structure">({</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">what</span>   <span class="operator">=&gt;</span> <span class="single">'do_send_form_to_parents'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">run_at</span> <span class="operator">=&gt;</span> <span class="word">DateTime</span><span class="operator">-&gt;</span><span class="word">now</span><span class="structure">()</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">add</span><span class="structure">(</span> <span class="word">year</span> <span class="operator">=&gt;</span> <span class="number">1</span> <span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">set_month</span><span class="structure">(</span><span class="number">2</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">truncate_to</span><span class="structure">(</span> <span class="word">to</span> <span class="operator">=&gt;</span> <span class="single">'month'</span> <span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">});</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>This will cause Schedule::LongSteps to schedule the <code>do_send_form_to_parents</code> step as the first step to be run for this instance. We also set the time when the step will become available to be executed with the <code>run_at</code> parameter. We&#39;d better implement the code for the steps in our class next...</p>

<p>Steps in the process are implemented as methods. The convention is to name them with the prefix &#39;do_&#39;, to avoid any possible conflict with future methods.</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;<br />42:&nbsp;<br />43:&nbsp;<br />44:&nbsp;<br />45:&nbsp;<br />46:&nbsp;<br />47:&nbsp;<br />48:&nbsp;<br />49:&nbsp;<br />50:&nbsp;<br />51:&nbsp;<br />52:&nbsp;<br />53:&nbsp;<br />54:&nbsp;<br />55:&nbsp;<br />56:&nbsp;<br />57:&nbsp;<br />58:&nbsp;<br />59:&nbsp;<br />60:&nbsp;<br />61:&nbsp;<br />62:&nbsp;<br />63:&nbsp;<br />64:&nbsp;<br />65:&nbsp;<br />66:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">sub</span> <span class="word">do_send_form_to_parents</span><span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span><span class="symbol">$self</span><span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$form</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">santaHQ</span><span class="structure">()</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">santas_pa</span><span class="structure">()</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">create_niceness_form</span><span class="structure">(</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">child</span><span class="structure">()</span> <span class="structure">);</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">santaHQ</span><span class="structure">()</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">outbox</span><span class="structure">()</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">send_letter</span><span class="structure">(</span> <span class="symbol">$form</span><span class="operator">,</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">child</span><span class="structure">()</span><span class="operator">-&gt;</span><span class="word">parental_address</span><span class="structure">()</span> <span class="structure">);</span><br /><br /><span class="comment">    # The following November, we want to check stuff.<br /></span>    <span class="keyword">return</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">new_step</span><span class="structure">({</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">what</span>   <span class="operator">=&gt;</span> <span class="single">'do_check_form_reception'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">run_at</span> <span class="operator">=&gt;</span> <span class="word">DateTime</span><span class="operator">-&gt;</span><span class="word">now</span><span class="structure">()</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">set_month</span><span class="structure">(</span><span class="number">11</span><span class="structure">)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">truncate_to</span><span class="structure">(</span> <span class="word">to</span> <span class="operator">=&gt;</span> <span class="single">'month'</span> <span class="structure">)</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">state</span>  <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cast">%</span><span class="structure">{</span><span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">state</span><span class="structure">()}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">form_id</span> <span class="operator">=&gt;</span> <span class="symbol">$form</span><span class="operator">-&gt;</span><span class="word">id</span><span class="structure">()</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">});</span><br /><span class="structure">}</span><br /><br /><span class="word">has</span> <span class="single">'form'</span> <span class="operator">=&gt;</span> <span class="structure">(</span> <span class="word">is</span> <span class="operator">=&gt;</span> <span class="single">'ro'</span><span class="operator">,</span> <span class="word">isa</span> <span class="operator">=&gt;</span> <span class="single">'My::Form'</span><span class="operator">,</span> <span class="word">lazy_build</span> <span class="operator">=&gt;</span> <span class="number">1</span> <span class="structure">);</span><br /><span class="keyword">sub</span> <span class="word">_build_form</span><span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span><span class="symbol">$self</span><span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">santaHQ</span><span class="structure">()</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">forms_register</span><span class="structure">()</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">find</span><span class="structure">(</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">state</span><span class="structure">()</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">form_id</span><span class="structure">}</span> <span class="structure">);</span><br /><span class="structure">}</span><br /><br /><span class="keyword">sub</span> <span class="word">do_check_form_reception</span><span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span><span class="symbol">$self</span><span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">unless</span><span class="structure">(</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">form</span><span class="structure">()</span><span class="operator">-&gt;</span><span class="word">is_back</span><span class="structure">()</span> <span class="structure">){</span><br /><span class="comment">        # Oh no! The form was not received, and so the child is<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# considered naughty. This is the end of the process.<br /></span>        <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">child</span><span class="operator">-&gt;</span><span class="word">has_been_naughty_in</span><span class="structure">(</span> <span class="word">DateTime</span><span class="operator">-&gt;</span><span class="word">now</span><span class="structure">()</span><span class="operator">-&gt;</span><span class="word">year</span><span class="structure">()</span> <span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">final_step</span><span class="structure">({</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">state</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cast">%</span><span class="structure">{</span><span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">state</span><span class="structure">()}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">reason</span> <span class="operator">=&gt;</span> <span class="single">'Missed deadline'</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">});</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><br /><span class="comment">    # The form has been returned - time to pick an elf and start<br />&nbsp;&nbsp;&nbsp;&nbsp;# the review process.<br /></span>    <span class="keyword">my</span> <span class="symbol">$reviewer_elf</span> <span class="operator">=</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">santaHQ</span><span class="structure">()</span><span class="operator">-&gt;</span><span class="word">most_available_elf</span><span class="structure">();</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">longsteps</span><span class="structure">()</span><span class="operator">-&gt;</span><span class="word">instantiate_process</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'My::Process::NicenessAssessment'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">{</span> <span class="word">santaHQ</span> <span class="operator">=&gt;</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">santaHQ</span><span class="structure">()</span> <span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">child_id</span> <span class="operator">=&gt;</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">child</span><span class="structure">()</span><span class="operator">-&gt;</span><span class="word">id</span><span class="structure">()</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">elf_id</span>   <span class="operator">=&gt;</span> <span class="symbol">$reviewer_elf</span><span class="operator">-&gt;</span><span class="word">id</span><span class="structure">()</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">form_id</span>  <span class="operator">=&gt;</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">form</span><span class="structure">()</span><span class="operator">-&gt;</span><span class="word">id</span><span class="structure">()</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">);</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">final_step</span><span class="structure">({</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">state</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cast">%</span><span class="structure">{</span><span class="symbol">$self</span><span class="operator">-&gt;</span><span class="word">state</span><span class="structure">()}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">reason</span> <span class="operator">=&gt;</span> <span class="single">'Form received'</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">});</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>Note that each step either schedules the next step or calls <code>final_step</code> to indicate we&#39;re done. Along the way we modify the state we store as we pick up new details of things we need to keep track of - like the form_id - that we need to populate our attributes again.</p>

<h3 id="Testing-Time">Testing Time!</h3>

<p>&#39;Wait, wait, wait,&#39; says one of the elves. &#39;This is supposed to happen in the future. How do we make sure today that this process will work?&#39;</p>

<p>Well, this is where unit testing comes into play. Here&#39;s how to write a test:</p>

<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">Test::MockDateTime</span><span class="structure">;</span><br /><span class="keyword">my</span> <span class="symbol">$longsteps</span> <span class="operator">=</span> <span class="word">Schedule::LongSteps</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">();</span><br /><br /><span class="keyword">my</span> <span class="symbol">$january</span>  <span class="operator">=</span> <span class="word">DateTime</span><span class="operator">-&gt;</span><span class="word">now</span><span class="operator">-&gt;</span><span class="word">set_month</span><span class="structure">(</span><span class="number">1</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">truncate</span><span class="structure">(</span> <span class="word">to</span> <span class="operator">=&gt;</span> <span class="single">'month'</span> <span class="structure">);</span><br /><span class="keyword">my</span> <span class="symbol">$february</span> <span class="operator">=</span> <span class="word">DateTime</span><span class="operator">-&gt;</span><span class="word">now</span><span class="operator">-&gt;</span><span class="word">set_month</span><span class="structure">(</span><span class="number">2</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">truncate</span><span class="structure">(</span> <span class="word">to</span> <span class="operator">=&gt;</span> <span class="single">'month'</span> <span class="structure">);</span><br /><span class="keyword">my</span> <span class="symbol">$november</span> <span class="operator">=</span> <span class="word">DateTime</span><span class="operator">-&gt;</span><span class="word">now</span><span class="operator">-&gt;</span><span class="word">set_month</span><span class="structure">(</span><span class="number">11</span><span class="structure">)</span><span class="operator">-&gt;</span><span class="word">truncate</span><span class="structure">(</span> <span class="word">to</span> <span class="operator">=&gt;</span> <span class="single">'month'</span> <span class="structure">);</span><br /><br /><span class="keyword">my</span> <span class="symbol">$p</span><span class="structure">;</span><br /><span class="word">on</span> <span class="symbol">$january</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span><span class="structure">{</span><br />&nbsp;&nbsp;<span class="symbol">$p</span> <span class="operator">=</span> <span class="symbol">$longsteps</span><span class="operator">-&gt;</span><span class="word">instantiate_process</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="single">'My::Process::NicenessFeedback'</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">{</span> <span class="word">santaHQ</span> <span class="operator">=&gt;</span> <span class="symbol">$santaHQ</span> <span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">{</span> <span class="word">child_id</span> <span class="operator">=&gt;</span> <span class="number">1234</span> <span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;<span class="structure">);</span><br /><span class="structure">};</span><br /><br /><span class="keyword">my</span> <span class="symbol">$form</span><span class="structure">;</span><br /><span class="word">on</span> <span class="symbol">$february</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span><span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$longsteps</span><span class="operator">-&gt;</span><span class="word">run_due_processes</span><span class="structure">({</span> <span class="word">santaHQ</span> <span class="operator">=&gt;</span> <span class="symbol">$santaHQ</span> <span class="structure">});</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$p</span> <span class="operator">=</span> <span class="symbol">$longsteps</span><span class="operator">-&gt;</span><span class="word">find_process</span><span class="structure">(</span> <span class="symbol">$p</span> <span class="structure">);</span> <span class="comment"># Reload process.</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$form</span> <span class="operator">=</span> <span class="symbol">$santaHQ</span><span class="operator">-&gt;</span><span class="word">forms_register</span><span class="structure">()</span><span class="operator">-&gt;</span><span class="word">find</span><span class="structure">(</span> <span class="symbol">$p</span><span class="operator">-&gt;</span><span class="word">state</span><span class="structure">()</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">form_id</span><span class="structure">}</span> <span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">ok</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$form</span><span class="operator">-&gt;</span><span class="word">is_sent</span><span class="structure">()</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="double">&quot;Process should now have a form_id, and the form should be sent&quot;</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">);</span><br /><span class="structure">};</span><br /><br /><span class="comment"># For this test, we assume the form was not sent back by November.<br /></span><span class="word">on</span> <span class="symbol">$november</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span><span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$longsteps</span><span class="operator">-&gt;</span><span class="word">run_due_processes</span><span class="structure">({</span> <span class="word">santaHQ</span> <span class="operator">=&gt;</span> <span class="symbol">$santaHQ</span> <span class="structure">});</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$child</span> <span class="operator">=</span> <span class="symbol">$santaHQ</span><span class="operator">-&gt;</span><span class="word">big_book_of_children</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="operator">-&gt;</span><span class="word">find</span><span class="structure">(</span> <span class="symbol">$p</span><span class="operator">-&gt;</span><span class="word">state</span><span class="structure">()</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">child_id</span><span class="structure">}</span> <span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">ok</span><span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$child</span><span class="operator">-&gt;</span><span class="word">has_been_naughty</span><span class="structure">()</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="double">&quot;Child is marked as naughty&quot;</span><span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">);</span><br /><span class="structure">};</span></code><br />&nbsp;</td></table>

<p>&#39;By Odin, Rudolf, this is jolly good,&#39; Santa says enthusiastically. &#39;So I just need to run <code>$longsteps-&gt;run_due_process()</code> from time to time?&#39;</p>

<p>&#39;That&#39;s right,&#39; Rudolph replies. &#39;We&#39;ll put it in a cron job or an Event loop watcher, and we&#39;re good to go. We don&#39;t even need to worry about concurrency, so we can have as many machines as we want doing it.&#39;</p>

<p>Santa looks thoughtful. &#39;And next year, maybe we can also use this to automate the gift-returning procedure...&#39;</p>

<h3 id="Disclaimer">Disclaimer</h3>

<p>Of course there is no Santa Klaus, and this code has not been tested anywhere other than Dreamland. But what is the future, if not our dreams come true?</p>

<h3 id="See-Also">See Also</h3>

<p><a href="https://metacpan.org/module/BPM::Engine">BPM::Engine</a> A business process engine based on XPDL</p>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/0fea6a56f9e78d979b944677d2be9e18?r=g&s=80&d=retro />
This article contributed by: Jerome Eteve &lt;jerome.eteve@gmail.com&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Gathering all the Presents" href="2016-12-05.html">Previous</a></li>

    <li class="next"><a title="Writing git hooks with Git::Hooks" href="2016-12-07.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>

    </div>



<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-27056407-1");
pageTracker._trackPageview();
} catch(err) {}</script>
</body>
</html>





